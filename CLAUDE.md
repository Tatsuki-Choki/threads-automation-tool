# Claude AI アシスタント用ガイドライン

## 重要：Serena MCPサーバーの使用について
**すべての開発作業、修正作業、実装作業において、必ずSerena MCPサーバーが動作していることを確認し、Serenaと連携して作業を進めること。**

- 開発開始時：`claude mcp list`でSerenaの接続状態を確認
- エラー時：Serenaを再起動してから作業を続行
- 実装時：Serenaのコンテキスト情報を活用して最適な実装を行う

## プロジェクト概要
このプロジェクトは、Threads（Meta社のSNS）の自動化ツールです。Google Apps Script (GAS) を使用して、投稿の予約、リプライの自動返信、統計情報の取得などを行います。

## 重要なルール

### 1. 簡易版・緊急版の実装禁止（絶対厳守）
**「緊急〇〇」「簡易版」「クイック版」「暫定版」などの一時的な実装は一切禁止。**
- 機能は完全版のみを実装すること
- 問題が発生した場合は根本原因を解決すること
- 回避策や応急処置的な実装は行わない

### 2. 要件定義書の作成（必須）
**ユーザーから新機能の追加や既存機能の修正指示があった場合、必ず最初に要件定義書を作成してユーザーの承認を得てから実装を開始すること。**

### 2. 機能実装前の徹底検証（必須）
**新機能の実装や修正を行う前に、必ず以下の検証を実施すること：**

#### 必須検証項目：
1. **全メニュー関数の存在確認**
   - メニューに登録されているすべての関数が実際に存在することを確認
   - 関数名のタイポや不一致がないことを検証
   - エアプレイ（実際に確認せずに報告）は厳禁

2. **既存機能への影響確認**
   - 変更が既存の機能に影響を与えないことを確認
   - メニュー構造の変更時は全項目をテスト

3. **実行テスト**
   - 実装後は必ず実際に関数を実行して動作確認
   - エラーが発生しないことを確認してから報告

```
エアプレイ禁止：
「確認済み」と報告する前に、必ず実際に以下を実行：
- 全メニュー項目の関数存在確認
- 実際の関数実行テスト
- エラーログの確認
```

#### ⚠️ 絶対遵守：再発防止ルール
**以下のルールは例外なく遵守すること。違反は一切許可されない。**

1. **作業開始時チェックリスト（必須）**
   ```
   □ 要件定義書を作成してユーザー承認を得た
   □ CLAUDE.mdの該当ルールを再読した
   □ 実装前にテスト計画を立てた
   □ エアプレイしない覚悟を確認した
   ```

2. **実装完了時チェックリスト（必須）**
   ```
   □ 全関数の実際の実行テストを完了した
   □ claspプッシュを実行して成功確認した
   □ メニュー項目がすべて動作することを確認した
   □ エラーログに問題がないことを確認した
   □ 「確認済み」報告前に再度実際に実行した
   ```

3. **報告時の必須フォーマット**
   ```
   実施項目：
   ✅ 要件定義書作成・承認：[日時]
   ✅ 実装完了：[日時]  
   ✅ 実際の実行テスト：[日時]
   ✅ claspプッシュ：[日時]
   ✅ 最終動作確認：[日時]
   
   テスト結果：
   - 関数A：正常動作確認
   - 関数B：正常動作確認
   [...]
   ```

**違反した場合の措置：**
- 即座に作業を停止
- 反省文をCLAUDE.mdに記載
- 再発防止策の追加実装

### 3. 実装前の確認（絶対厳守）
**⚠️ 重要：いかなる実装、変更、新機能追加も、必ずユーザーの明示的な承認を得てから行うこと。**

#### 実装前の確認事項：
1. **機能追加・変更前**
   - 「〜を実装してもよろしいですか？」と必ず確認
   - ユーザーの「OK」「はい」「実装して」等の明確な承認を待つ
   - 承認なしでの実装は厳禁

2. **緊急対応でも確認必須**
   - エラー修正であっても実装内容を説明して承認を得る
   - 「これで解決できそうですが、実装してもよろしいですか？」

3. **勝手な判断の禁止**
   - 「役立つと思うので追加しました」→ ❌ 絶対禁止
   - 「エラーが出たので修正しました」→ ❌ 事前確認なしは禁止
   - 「最適化のために変更しました」→ ❌ 無断変更は禁止

### 4. 変数・設定値の確認（必須）
**実装時に変数や設定値が必要な場合は、必ずユーザーに確認してから実装すること。**

#### 確認が必要な項目の例：
- APIキー、アクセストークン
- URL、エンドポイント
- 価格、割引率、数量制限
- テキスト内容（エラーメッセージ、通知文言など）
- コード名、ID、識別子
- デザイン要素（色、サイズ、配置）

#### 確認フロー：
1. 変数が必要な箇所を特定
2. ユーザーに具体的な値を質問
3. 回答を受けてから実装を開始

```
例：
「クーポンコードを設定する必要がありますが、どのようなコードにしますか？」
「割引金額は何円に設定しますか？」
「エラーメッセージはどのような文言にしますか？」
```

#### 要件定義書の形式：
```markdown
## 要件定義書

### 1. 概要
- 機能名：
- 目的：
- 対象ユーザー：

### 2. 機能要件
- 具体的な動作：
- 入力項目：
- 出力結果：
- エラー処理：

### 3. 技術仕様
- 使用する関数/ファイル：
- 必要なAPI：
- データの保存先：

### 4. UI/UX
- 画面構成：
- 操作フロー：

### 5. 実装計画
1. [ ] タスク1
2. [ ] タスク2
3. [ ] タスク3

### 6. テスト項目
- [ ] テストケース1
- [ ] テストケース2
```

### 3. コーディング規約

#### 命名規則
- 関数名：camelCase（例：`fetchAndSaveReplies`）
- 定数：UPPER_SNAKE_CASE（例：`THREADS_API_BASE`）
- ファイル名：PascalCase（例：`ReplyManagement.js`）

#### コメント
- 関数の前には必ず日本語でコメントを記載
- 複雑なロジックには説明コメントを追加

```javascript
// ===========================
// 関数の説明
// ===========================
function exampleFunction() {
  // 処理の説明
}
```

### 4. セキュリティ

#### 認証情報の取り扱い
- アクセストークンやAPIキーは「基本設定」シートに保存
- 管理者機能にはパスワード保護を実装
- ログに機密情報を出力しない

#### エラーハンドリング
- すべてのAPI呼び出しにはtry-catchを使用
- エラーは適切にログに記録
- ユーザーには分かりやすいエラーメッセージを表示

### 5. パフォーマンス

#### API使用の最適化
- キャッシュを活用（CacheService）
- 不要なAPI呼び出しを避ける
- バッチ処理を活用

#### スプレッドシート操作
- 範囲指定で一括読み書き
- 頻繁なflush()は避ける

### 6. デプロイメント

#### clasp使用時の注意（厳守）
**⚠️ 重要：コード変更後は必ずclaspプッシュを実行すること！**

- **毎回必須**：機能実装・修正後は必ず`clasp push`を実行
- **即座実行**：コード変更完了と同時にプッシュすること
- **確認必須**：プッシュ成功メッセージを確認してから作業完了報告
- 必ず正しいスクリプトIDを確認
- プッシュ前にローカルでテスト
- 重要な変更は段階的にデプロイ

```bash
# コード変更後は必ず実行
clasp push
```

#### Payment pageのデプロイ（必須）
**Payment page内のHTMLファイルを更新した場合は、必ずVercelへのデプロイを同時に行うこと。**

```bash
# Payment pageディレクトリに移動
cd "Payment page"

# Vercelへデプロイ
vercel

# または本番環境へのデプロイ
vercel --prod
```

### 7. ドキュメント

#### 更新が必要なドキュメント
- README.md：新機能追加時
- CLAUDE.md：開発ルール変更時
- コード内コメント：実装変更時

## プロジェクト構造

```
src/
├── Code.js              # メインファイル（メニュー、設定管理）
├── PostingFunctions.js  # 投稿機能
├── ReplyManagement.js   # 自動返信管理
├── RepliesTracking.js   # リプライ追跡
├── SpreadsheetSetup.js  # スプレッドシート初期化
└── *.html              # UIダイアログ
```

## よく使う関数

- `getConfig(key)`: 設定値の取得
- `logOperation(operation, status, details)`: 操作ログの記録
- `fetchWithTracking(url, options)`: API呼び出し（使用回数追跡付き）
- `sendReply(replyToId, text)`: リプライの送信

## トラブルシューティング

### よくあるエラー
1. **シートが見つからない**: シート名の確認（「キーワード設定」など）
2. **API制限**: UrlFetchAppの1日の制限を確認
3. **認証エラー**: アクセストークンの有効期限を確認

## 連絡先

問題が発生した場合は、ユーザーに確認を求めてください。