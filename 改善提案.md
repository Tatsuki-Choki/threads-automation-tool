# 改善提案（セキュリティ・設計・運用）

本ドキュメントは、現状のリポジトリ（Threads Apps Script + 決済ページ）に対するコードレビューの所見と、推奨する改善策をまとめたものです。重要度の高いものから順に記載しています。機密値そのものは本文へ再掲しない形で記述しています。

## 重要（直ちに対処）

- 機密情報のリポジトリ混入（重大）
  - 対象:
    - `client_secret_*.json`（Google OAuth クライアントシークレット）
    - `Payment page/.env`（`STRIPE_SECRET_KEY` を含む）
    - コード内のハードコード値: `VERIFY_TOKEN`（Webhook検証トークン）, `SHEET_PROTECTION_PASSWORD`, `ADMIN_PASSWORD` のデフォルト値 等
  - リスク:
    - 外部流出・不正利用（Stripe課金、OAuth 乗っ取り等）。Forkや過去コミットからも参照可能。
  - 対策（必須）:
    - 直ちに鍵・トークンをローテーション（Stripe ダッシュボード / Google Cloud Console）。
    - Git 履歴から機密情報を完全除去（例: `git filter-repo` または BFG）。
    - `.env` 類はコミット禁止・環境変数で注入（Vercel/Cloud Run/Apps Script Properties）。
    - Apps Script 側のシークレットは Script Properties（`PropertiesService.getScriptProperties()`）や Secret Manager を使用。シートには保存しない。

- Webhook 署名検証が実質無効（設計上の問題）
  - 現状:
    - Apps Script の `doPost(e)` で `e.parameter['x-hub-signature-256']` を参照しているが、Apps Script Web アプリは HTTP ヘッダを取得できません（署名ヘッダは届かない）。
    - `APP_SECRET` 未設定時に検証をスキップして常に許可している。
    - エラーでも 200 を返しており濫用に弱い。
  - リスク:
    - なりすましリクエストを正規 Webhook と誤認。自動返信やAPI呼び出しが外部から恣意的に起動可能。
  - 対策（推奨アーキテクチャ）:
    - Webhook 受信は Apps Script から分離し、Cloud Run/Cloud Functions など HTTP ヘッダを取得できる環境に移設。
    - 署名検証（HMAC SHA-256）を確実に実施し、失敗時は 403 を返す（リトライ上限・ログ監視も設定）。
    - 移設先で必要最低限の情報のみ Apps Script へ転送（Pub/Sub、または REST 経由）。Apps Script 側は署名不要のバックエンド連携専用に限定。

- ハードコードされたパスワード/トークンの撤廃
  - 該当:
    - `SHEET_PROTECTION_PASSWORD = '...@...'`（ソースに平文）
    - `ADMIN_PASSWORD` のデフォルト値（メールアドレス）
    - `WEBHOOK_CONFIG.VERIFY_TOKEN`
  - リスク:
    - コードを読めるユーザー（共同編集者/外部）に容易に露見。形式的な“保護”になっておらず実質無防備。
  - 対策:
    - すべて Script Properties/Secret Manager に移行し、未設定時は「機能停止」する挙動に変更（デフォルト値を廃止）。
    - シート表示/非表示の“擬似パスワード”は廃止し、Google アカウント権限・シート保護を正しく活用。

- 決済 API（Stripe）の CORS/CSRF 対応
  - 現状:
    - `Payment page/api/create-checkout-session.js` が `Access-Control-Allow-Origin: *` と `Allow-Credentials: true` を同時に設定（仕様上矛盾）。
    - `.env` に本番用 `STRIPE_SECRET_KEY` が含まれたままコミット。
  - リスク:
    - 任意オリジンから Checkout Session を発行される恐れ。鍵流出時の被害拡大。
  - 対策:
    - CORS: 許可オリジンをドメイン固定（例: `https://your-domain.com` のみ許可）。`*` は使用しない。`Allow-Credentials` は必要時のみ。
    - CSRF/リファラチェック・簡易APIキー・レートリミット導入（Vercel Middleware/Edge も検討）。
    - `.env` はコミット禁止。Vercel の環境変数を利用。

- 大量一括デプロイの危険（`batch_push.sh` / npm scripts）
  - 現状:
    - `clasp push --force` を多数の Script ID に対して無確認で実行。
  - リスク:
    - 間違った環境へ誤配布・上書き。ヒューマンエラーによる広範な事故。
  - 対策:
    - 実行前にインタラクティブ確認（YES/NO）。実行対象は外部設定ファイルから読み込み、コメント/タグで明示管理。
    - `--dry-run` モードの追加、対象ごとの差分表示、失敗時の即時中断、実行ログの保存。

## 中（優先的に改善）

- エラーハンドリングと情報漏えい
  - `doPost` でエラー詳細をクライアントへ返却、`fetchWithTracking` でリクエスト/ペイロードを詳細ログ出力。
  - 対策: 外部応答は汎用メッセージに統一。ログはレベル制御とマスキング（トークン・個人情報の除去）。

- 機密設定の保存場所
  - 現状: 「基本設定」シートにトークン・クライアント秘密等を保存しうる。
  - リスク: シート閲覧権限を持つ全ユーザーへ露出。誤共有時の漏えい。
  - 対策: Script Properties/Secret Manager へ移行。シートは参照トグルやメタ情報のみに限定。値は伏字表示/コピー不可のUIに。

- リダイレクトURIのハードコード
  - `initializeSettingsSheet` で固定 URI が投入される。
  - 対策: 現在の WebApp URL から導出・手順提示に留めるか、手入力フローに一本化。

- レート制限/バックオフの体系化
  - 現状: `Utilities.sleep` の散発的利用。
  - 対策: API 呼び出しを一箇所に集約（`fetchWithTracking`）し、指数バックオフ/再試行・429/5xxハンドリングを標準化。

- ログの粒度とPIIの扱い
  - 対策: 収集目的を明確化し、最小化。PII（ユーザー名/テキスト）は要約・件数統計中心に。全文はオプトイン/デバッグ時のみ。

## 低（継続的改善）

- 命名/表記ゆれ・不要コード
  - 例: 日本語が混じる変数名、未使用変数（`totalDaysInMonth` など）。
  - 対策: ESLint/Prettier を導入、CI で型/静的検査（可能なら `clasp` + `gas-types`）。

- テスト容易性
  - 対策: 主要ユーティリティ（署名計算・キーワード照合）を純関数化し、gas-local などでユニットテスト可能に。

## 推奨修正の具体例

- Secrets を Script Properties に移動（例）
  - 保存: `PropertiesService.getScriptProperties().setProperty('APP_SECRET', '...')`
  - 取得: `const APP_SECRET = PropertiesService.getScriptProperties().getProperty('APP_SECRET');`
  - 未設定なら機能停止/警告（デフォルト値での“擬似保護”は廃止）。

- CORS の許可オリジン固定（例: Vercel）
  ```js
  const ALLOW_ORIGINS = [
    'https://your-domain.com',
    'https://your-landing.vercel.app'
  ];
  const origin = req.headers.origin || '';
  if (ALLOW_ORIGINS.includes(origin)) {
    res.setHeader('Access-Control-Allow-Origin', origin);
    res.setHeader('Vary', 'Origin');
  }
  // Allow-Credentials は必要時のみ true
  ```

- `batch_push.sh` の安全化（例）
  ```bash
  read -p "THIS WILL push to ${#script_ids[@]} projects. Continue? (yes/NO): " ans
  [[ "$ans" == "yes" ]] || { echo "Aborted"; exit 1; }
  set -euo pipefail
  # dry-run オプションや差分表示を先に
  ```

- Webhook の移設方針（概要）
  - Cloud Run（Node/Go/Python など）に `/webhook` を実装
    - リクエストボディと `x-hub-signature-256` を取得
    - `APP_SECRET` で HMAC 検証、失敗は 403
    - 正常時のみ必要最小データを Apps Script/API へ転送
  - Secrets は Cloud Secret Manager / 環境変数から注入
  - Cloud Logging + アラート（エラー率や 403 増加を監視）

- Git 履歴からの機密除去
  - 代表手順（要バックアップ）
    - `git filter-repo --path Payment\ page/.env --invert-paths`（BFG でも可）
    - `git filter-repo --path client_secret_*.json --invert-paths`
    - GitHub へ強制プッシュ（影響範囲調整に注意）。
  - 実行後に全鍵・トークンの再発行を必ず実施。

## 次のアクション（チェックリスト）

- [ ] Stripe 秘密鍵・Price ID の即時ローテーション（本番/検証の分離）
- [ ] Google OAuth クライアントシークレットの再発行
- [ ] 機密ファイルの Git 履歴からの完全除去（filter-repo/BFG）
- [ ] Apps Script: Script Properties/Secret Manager への移行（シート保存の廃止）
- [ ] `VERIFY_TOKEN`/パスワードのハードコード撤廃とデフォルト値の廃止
- [ ] Webhook を Cloud Run/Functions へ移設し、署名検証を厳格化
- [ ] 決済APIの CORS/CSRF/レートリミット導入と許可オリジン固定
- [ ] 一括デプロイ系スクリプトに確認プロンプト/ドライラン追加
- [ ] ログのマスキング・レベル制御導入（PII/トークン非出力）
- [ ] ESLint/Prettier/最小限のユニットテスト整備

---

不明点や優先度の調整が必要であれば、どの項目から着手するかご指定ください。最優先は「鍵・トークンのローテーション」と「履歴からの秘匿情報の除去」です。
